name: Enforce Promotion Path

on:
  pull_request:
    branches: [main, v2/proto]

# Minimal permissions - this workflow only checks branch names
permissions: {}

jobs:
  check-source-branch:
    runs-on: ubuntu-latest
    steps:
      - name: Verify PR is from correct source branch
        env:
          HEAD_REF: ${{ github.head_ref }}
          BASE_REF: ${{ github.base_ref }}
        run: |
          # Determine required source branch based on target
          case "$BASE_REF" in
            main)
              REQUIRED_SOURCE="test"
              ;;
            v2/proto)
              REQUIRED_SOURCE="v2/dev"
              ;;
            *)
              echo "❌ Unknown target branch: $BASE_REF"
              exit 1
              ;;
          esac

          if [ "$HEAD_REF" != "$REQUIRED_SOURCE" ]; then
            echo "❌ PRs to '$BASE_REF' must come from the '$REQUIRED_SOURCE' branch"
            echo ""
            echo "Current source branch: $HEAD_REF"
            echo ""
            echo "Workflow:"
            echo "  1. Push changes to '$REQUIRED_SOURCE' branch"
            echo "  2. Use 'Promote Release' workflow to create PR from $REQUIRED_SOURCE → $BASE_REF"
            echo "  3. Or manually create PR from '$REQUIRED_SOURCE' to '$BASE_REF'"
            exit 1
          fi
          echo "✅ PR is from '$REQUIRED_SOURCE' branch - promotion allowed"
