#!/bin/sh
# Pre-push scope guard (POSIX sh)
# Enforces branch naming alignment: <type>/<section>[/<subsection>]/<feature>
# Types: feature|bugfix|hotfix|design|refactor|test|doc
# Bypass with: SKIP_SCOPE_GUARD=1 or --no-verify

set -eu

[ "${SKIP_SCOPE_GUARD:-0}" = "1" ] && exit 0

branch_type_re='feature\|bugfix\|hotfix\|design\|refactor\|test\|doc'

is_zero() { [ "$1" = "0000000000000000000000000000000000000000" ]; }

allow_file='.scope-allow.json'

err=0

while read local_ref local_sha remote_ref remote_sha; do
  # Skip empty lines
  [ -z "${local_ref:-}" ] && continue
  case "$local_ref" in refs/heads/*) branch_name=${local_ref#refs/heads/} ;; *) branch_name=$local_ref ;; esac

  # Parse <type>/<section>/...
  type=$(echo "$branch_name" | cut -d/ -f1)
  section=$(echo "$branch_name" | cut -d/ -f2)
  # Ensure branch type matches allowed set
  printf '%s' "$type" | grep -Eq "^($branch_type_re)$" || { continue; }
  [ -z "$section" ] && continue

  # Determine diff range
  if is_zero "$remote_sha"; then
    base=$(git merge-base "$local_sha" origin/main 2>/dev/null || echo "")
    if [ -n "$base" ]; then range="$base..$local_sha"; else range="$local_sha^..$local_sha"; fi
  else
    range="$remote_sha..$local_sha"
  fi

  # Changed files
  changed=$(git diff --name-only --diff-filter=ACMR "$range" | sed '/^$/d' || true)
  [ -z "$changed" ] && continue

  # Token list: section plus optional extra from .scope-allow.json
  tokens="$section"
  if [ -f "$allow_file" ]; then
    extra=$(sed -n -e 's/[[:cntrl:]]//g' -e "/\"$branch_name\"[[:space:]]*:/,/[}\]]/p" "$allow_file" \
      | tr ',"[]' ' ' | awk '{for(i=1;i<=NF;i++) if(length($i)) print $i}' | sed -e '1d' || true)
    [ -n "$extra" ] && tokens="$tokens $extra"
  fi

  out_of_scope=""
  echo "$changed" | while IFS= read -r p; do
    in_scope=1 # default ok for broad sections; tighten below
    # Require one token to match as a path segment
    in_scope=0
    for t in $tokens; do
      case "$p" in
        "$t"|"$t"/*|*/"$t"/*|*/"$t") in_scope=1; break ;;
      esac
    done
    if [ $in_scope -eq 0 ]; then
      out_of_scope="$out_of_scope\n    - $p"
    fi
  done

  if [ -n "$out_of_scope" ]; then
    printf "\n[pre-push] Scope guard failed for branch '%s'\n" "$branch_name" >&2
    printf "  Section: %s\n" "$section" >&2
    printf "  Changed files outside scope tokens (%s):%s\n" "$tokens" "$out_of_scope" >&2
    printf "\nHints:\n  - If cross-cutting, push with --no-verify or set SKIP_SCOPE_GUARD=1\n  - Or extend tokens for this branch in .scope-allow.json\n" >&2
    err=1
  fi
done

exit $err
